<!DOCTYPE HTML>
<html lang="en-US">
<head>
	<title>Shower</title>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=1234, user-scalable=no">
	<link rel="stylesheet" href="themes/ribbon/styles/style.css">
	<style>
		#Cover H2 {
			color:#FFF;
			text-align:center;
			font-size:70px;
			}
	</style>
<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.6.2/jquery.min.js"></script>

<link rel="stylesheet" href="http://yandex.st/highlightjs/6.0/styles/github.min.css">
<script src="http://yandex.st/highlightjs/6.0/highlight.min.js"></script>
<script>hljs.initHighlightingOnLoad();</script>

</head>
<body class="list">
	<header class="caption">
		<h1>Play Framework - Making a java webframework looking less Java</h1>
		<p>Alexander Reelsen</p>
	</header>
	

<div class="slide" id="Cover"><div>
	<section style="background-color: white">
	  <header>
        <h1>Play Framework</h1>
		<h2 style="color: gray">A look inside the machine room</h2>
      </header>
			<img src="images/play-logo.png">
			<div style="text-align : right;">
			Alexander Reelsen<br />
			alexander@reelsen.net<br />
			@spinscale
			</div>
	</section>
</div></div>

<div class="slide" id="internals-toc"><div>
  <section>
    <header>
      <h2>Inside the machine room</h2>
    </header>
    <ul>
      <li>Model:
        <ul>
          <li>Property Enhancement</li>
          <li>Finders</li>
        </ul>
      </li>
      <li>Controller:
        <ul>
          <li>Redirects</li>
          <li>Rendering context</li>
        </ul>
      </li>
    </ul>
  </section>
</div></div>

<div class="slide" id="about"><div>
  <section>
    <header>
      <h2>About me - Alexander Reelsen</h2>
    </header>
    <ul>
      <li>Studied information systems</li>
      <li>10 years linux system engineering, converted to software engineering</li>
      <li>Web framework enthusiast, fed up with complex java environment for simple webapps</li>
      <li>Other interests: Scaling web architectures, Web 2.0 (nosql, search)</li>
      <li>Started with play 1.0 in 2009, started writing cookbook in dec 2010</li>
      <li>Streetball/Basketball</li>
    </ul>
  </section>
</div></div>

<div class="slide" id="code-sample"><div>
  <section>
    <header>
      <h2>Code sample - Entity</h2>
    </header>
<pre><code>@Entity public User extends Model {
  public String name;
  public String password;
  public void setPassword(String pwd) {
    password = Crypto.passwordHash(pwd);
  }
  public boolean hasPassword(String pwd) {
    return Crypto.passwordHash(pwd).equals(password);
  }
}</code></pre>
  </section>
</div></div>

<div class="slide" id="code-sample-2"><div>
  <section>
    <header>
      <h2>Code sample - Controller</h2>
    </header>
<pre><code class="java">public static void setPassword(String nw, String old) {
  User user = User.findById((Long)session.get("id"));
  notFoundIfNull(user);
  if (!user.hasPassword(old)) {
    index();
  }
  user.password = nw;
  user.save();
  render(user);
}</code></pre>
  </section>
</div></div>

<div class="slide" id="property-enhancer"><div>
  <section>
    <header>
      <h2>Property enhancement</h2>
    </header>
    <ul>
      <li>What happens in <code>user.password = nw;</code>?</li>
      <li>According to the documentation: The setter is called - but how?</li>
      <li>Solution: <code>play.classloading.enhancers.PropertiesEnhancer</code></li>
      <li>Performing bytecode enhancement via javassist library</li>
      <li>Enhancer loops over all fields, checks if getters/setters exist, creates them if necessary</li>
      <li>Next step: Intercept all field accesses and redirect to getters/setters</li>
      <li>Similar: <a href="">Project Lombok</a>, Scala, many other languages</li>
    </ul>
  </section>
</div></div>

<div class="slide" id="property-enhancer-2"><div>
  <section>
    <header>
      <h2>Example getter/setter creation with javassist</h2>
    </header>
<pre><code>String code =
    "public String getName() { return this.name; }";
CtMethod getMethod = CtMethod.make(code, ctClass);
ctClass.addMethod(getMethod);

code = "public void setName(String value) " + 
  "{ this.name = value; }";
CtMethod setMethod = CtMethod.make(code, ctClass);
ctClass.addMethod(setMethod);</code></pre>
  </section>
</div></div>

<div class="slide" id="property-enhancement-field-interception"><div>
  <section>
    <header>
      <h2>Intercept field access, replace with getter/setter</h2>
    </header>
    <ul>
      <li><code>ExprEditor</code> from javassist is used, can be used to replace calls inside a method body, instead of replacing the method itself</li>
      <li>Intercepts field access, no matter if in model, controller or template</li>
      <li>Invokes either <code>FieldAccessor.invokeReadProperty()</code> or <code>FieldAccessor.invokeWriteProperty()</code>, which calls either getter or setter</li>
    </ul>
  </section>
</div></div>

<div class="slide bg" id="screenshot-controller-code-from-eclipse"><div>
  <section>
    <img src="images/controller-bytecode-model-propertyenhancement.png">
  </section>
</div></div>

<div class="slide" id="finders"><div>
  <section>
    <header>
      <h2>Finders in models</h2>
    </header>
    <ul>
      <li>How does <code>User.find("byName", "alexander");</code> work?</li>
      <li>Core problem: <code>Model.find()</code> is a static method</li>
      <li>Nothing is overwritten in the User entity</li>
      <li>Hierarchy: <code>User</code> > <code>Model</code> > <code>GenericModel</code> > <code>JPABase</code></li>
      <li>GenericModel:
        <pre><code>public static JPAQuery find(String query, Object... params) {
  throw new UnsupportedOperationException("Please 
    annotate your JPA model...");
}</code></pre>    </ul>
  </section>
</div></div>

<div class="slide" id="finders-enhancer"><div>
  <section>
    <header>
      <h2><code>play.db.jpa.JPAEnhancer</code></h2>
    </header>
    Enhancer loops through all entities and adds static methods
<pre><code>// public static play.db.jpa.GenericModel.JPAQuery
// find(String query, Object[] params) {
//   return play.db.jpa.JPQL.instance.find(entityName, 
//     query, params);
// };
CtMethod find = CtMethod.make(code, ctClass);
ctClass.addMethod(find);
</code></pre>
  </section>
</div></div>

<div class="slide" id="finders-enhancer-2"><div>
  <section>
    <header>
      <h2><code>play.db.jpa.JPAEnhancer</code></h2>
    </header>
    <ul>
      <li>Similar code applies to other static methods</li>
      <li><code>count()</code>, <code>count(query, params)</code></li>
      <li><code>findAll()</code>, <code>findById(id)</code>, <code>find(query, params)</code>, <code>findOneBy(query, params)</code></li>
      <li><code>deleteAll()</code>, <code>delete(query, params)</code></li>
      <li><code>create()</code></li>
    </ul>
  </section>
</div></div>


<div class="slide" id="bytecode-disassembly"><div>
  <section>
    <header>
      <h2>Deep dive: Disassembling bytecode</h2>
    </header>
    <ul>
      <li>Problem: Debugging is hard and sucks</li>
      <li>Back to the compile, restart cycle</li>
      <li>You never have exact info how bytecode was applied</li>
      <li>Solution: <code>javap -verbose -c User</code></li>
      <li>Better solution: <a href="http://java.decompiler.free.fr/">JD-Gui</a></li>
    </ul>
  </section>
</div></div>

<div class="slide bg" id="screenshot-jdgui"><div>
  <section>
    <img src="images/jd-gui.png">
  </section>
</div></div>


<div class="slide" id="controller-redirects"><div>
  <section>
    <header>
      <h2>Controller redirects</h2>
    </header>
Calling another controller in java issues a HTTP redirect
<pre><code>public static void redirect() {
  index();
}</code></pre>
<pre><code> curl -v localhost:9000/redirect
< HTTP/1.1 302 Found
< Location: http://localhost:9000/
</code></pre>
  </section>
</div></div>

<div class="slide" id="controller-redirects-logic"><div>
  <section>
    <header>
      <h2>Controller redirects - logic</h2>
    </header>
    <ul>
      <li><code>play.classloading.enhancers.ControllersEnhancer</code></li>
      <li>Every action is enhanced</li>
      <li>As soon as an action is started, a boolean is set</li>
      <li>On every action invocation this boolean is checked</li>
      <li>If it is already true, this means the action is called from another java method and a redirect is issued</li>
      <li>If it is false, the controller logic is executed
    </ul>
  </section>
</div></div>

<div class="slide" id="controller-redirects-2"><div>
  <section>
    <header>
      <h2>Controller redirects - bytecode</h2>
    </header>
      Inserted before every controller call
<pre><code>if(!play.classloading.enhancers.ControllersEnhancer.
    ControllerInstrumentation.isActionCallAllowed()) {
      play.mvc.Controller.redirect(
        "controllers.Application.index", $args);
      return;
    }
    play.classloading.enhancers.ControllersEnhancer.
      ControllerInstrumentation.stopActionCall();</code</pre>
  </section>
</div></div>

<div class="slide" id="controller-redirects-3"><div>
  <section>
    <header>
      <h2>Disassembled controller code - is different</h2>
    </header>
<pre><code>if (!ControllersEnhancer.
  ControllerInstrumentation.isActionCallAllowed()) {
  Controller.redirect("controllers.Application.index",
    new Object[0]);
} else {
  ControllersEnhancer.ControllerInstrumentation
    .stopActionCall();
  // controller logic comes here...
}</code></pre> 
  </section>
</div></div>

<div class="slide bg" id="screenshot-controller-code"><div>
  <section>
    <img src="images/controller-bytecode-controller-redirect.png">
  </section>
</div></div>

<div class="slide" id="rendering-context"><div>
  <section>
    <header>
      <h2>Rendering context</h2>
    </header>
How does this work?
<pre><code>List&lt;User> users = User.findAll();
String message = "FooBarBaz";
render(<mark class="important">users</mark>, <mark>message</mark>);</code></pre>
<pre><code>&lt;div><mark>${message}</mark>&lt;/div>
#{list <mark class="important">users</mark>, as:'user'}
&lt;li>${user.name}&lt;/li>
#{/list}</code></pre>
  </section>
</div></div>

<div class="slide" id="rendering-context-2"><div>
  <section>
    <header>
      <h2>Rendering context - how it works</h2>
    </header>
<code>play.classloading.enhancers.LocalvariablesNamesEnhancer</code>
    <ul>
      <li>Every variable declaration in an action creates a sort of history entry in <code>LocalVariablesNamesTracer.localVariables</code> <!-- typed <code>ThreadLocal&lt;Stack&lt;Map&lt;String, Object>>></code> --></li>
      <li>When rendering the template every object added to the <code>render()</code> method is checked with this <code>localVariables</code> variable</li>
      <li>Example: <pre><code>List&lt;User> users = User.findAll();
LocalVariablesNamesTracer.addVariable("users", users);</code></pre></li>
    </ul>
  </section>
</div></div>

<div class="slide" id="rendering-context-3"><div>
  <section>
    <header>
      <h2>Rendering context - how it works</h2>
    </header>
<pre style="font-size: smaller"><code>protected static void renderTemplate(String templateName, 
 Object... args) {
  Map<String, Object> templateBinding = new HashMap<String, Object>(16);
  for (Object o : args) {
    List<String> names =
      <mark>LocalVariablesNamesTracer.getAllLocalVariableNames(o);</mark>
    for (String name : names) {
      templateBinding.put(name, o);
    }
  }
  renderTemplate(templateName, templateBinding);
}</code></pre>
  </section>
</div></div>

<div class="slide bg" id="screenshot-controller-code-from-eclipse-2"><div>
  <section>
    <img src="images/controller-bytecode-controller-rendering.png">
  </section>
</div></div>

<div class="slide shout" id="finish"><div>
  <section>
    <header>
      <h2>Questions?</h2>
    </header>
  </section>
</div></div>


<div class="slide" id="book-introduction"><div>
  <section>
    <header>
      <h2>Books: Introducing the Play! framework</h2>
    </header>
    <div style="float: left; padding-right: 1em"><img src="images/playframework-book-introduction.jpg"></div>
    <div><a href="http://the-play-book.co.uk">Introducing the Play! framework</a><br />by Wayne Ellis</a></div>
    <div style="float: none"></div>
  </section>
</div></div>


<div class="slide" id="book-cookbook"><div>
  <section>
    <header>
      <h2>Books: Play Framework Cookbook</h2>
    </header>
    <div style="float: left; padding-right: 1em; width: 40%"><img width="100%" src="images/playframework-book-cookbook.jpg"></div>
    <div><a href="http://www.packtpub.com/play-framework-cookbook/book">Play Framework Cookbook</a><br />by Alexander Reelsen</a></div>
    <div style="float: none"></div>
  </section>
</div></div>


<div class="slide" id="resources"><div>
  <section>
    <header>
      <h2>Resources</h2>
    </header>
    <ul>
      <li><a href="http://www.playframework.org">Playframework</a></li>
      <li>Twitter: <a href="http://twitter.com/playframework">@playframework</a></li>
      <li>My presentations at <a href="http://www.slideshare.net/areelsen/">slideshare</a></li>
      <li>German: Articles from 2009 in kaffeeklatsch magazine (<a href="http://www.bookware.de/kaffeeklatsch/archiv/ KaffeeKlatsch-2009-11.pdf">part 1</a>, <a href="http://www.bookware.de/kaffeeklatsch/archiv/ KaffeeKlatsch-2009-12.pdf">part 2</a>)</li>
      <li><a href="http://www.packtpub.com/play-framework-cookbook/book">Play framework cookbook</a> (example sources on <a href="https://github.com/spinscale/">github</a>)</li>
      <li>Presentation has been done with <a href="https://github.com/pepelsbey/shower">shower</a></li>
    </ul>
  </section>
</div></div>


<div class="progress"><div></div></div>
<script src="scripts/script.js"></script>

</body>
</html>
